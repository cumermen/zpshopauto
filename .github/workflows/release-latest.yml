name: Release Latest Plugin Jar

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: "25"
          distribution: "temurin"

      - name: Elevate wrapper permissions
        run: chmod +x ./gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          dependency-graph: generate-and-submit

      - name: Build Plugin
        run: ./gradlew clean build --no-daemon

      - name: Prepare release artifacts
        run: |
          PLUGIN_NAME=$(grep '^plugin_name=' gradle.properties | cut -d'=' -f2)
          PLUGIN_VERSION=$(grep '^plugin_version=' gradle.properties | cut -d'=' -f2)
          VERSIONED_JAR="build/libs/${PLUGIN_NAME}-${PLUGIN_VERSION}.jar"

          if [ ! -f "$VERSIONED_JAR" ]; then
            VERSIONED_JAR=$(find build/libs -maxdepth 1 -type f -name '*.jar' ! -name '*-sources.jar' ! -name '*-javadoc.jar' | head -n 1)
          fi

          cp "$VERSIONED_JAR" "${PLUGIN_NAME}.jar"
          cp "$VERSIONED_JAR" "${PLUGIN_NAME}-${PLUGIN_VERSION}.jar"

          echo "PLUGIN_NAME=$PLUGIN_NAME" >> "$GITHUB_ENV"
          echo "PLUGIN_VERSION=$PLUGIN_VERSION" >> "$GITHUB_ENV"

      - name: Publish / update latest release
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Latest Build
          body: "Automated build for commit ${{ github.sha }}."
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
          removeArtifacts: true
          artifacts: "${{ env.PLUGIN_NAME }}.jar,${{ env.PLUGIN_NAME }}-${{ env.PLUGIN_VERSION }}.jar"

name: Release Latest Plugin Jar

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Prepare release artifacts
        run: |
          VERSIONED_JAR=$(find . -maxdepth 1 -type f -name '*.jar' ! -name '*-sources.jar' ! -name '*-javadoc.jar' | head -n 1)
          if [ -z "$VERSIONED_JAR" ]; then
            echo "No plugin jar found in repo root."
            exit 1
          fi

          PLUGIN_NAME="ZenithProxyShopAutomation"
          cp "$VERSIONED_JAR" "${PLUGIN_NAME}.jar"
          BASENAME=$(basename "$VERSIONED_JAR")

          echo "PLUGIN_NAME=$PLUGIN_NAME" >> "$GITHUB_ENV"
          echo "VERSIONED_BASENAME=$BASENAME" >> "$GITHUB_ENV"

      - name: Publish / update latest release
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Latest Build
          body: "Automated build for commit ${{ github.sha }}."
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
          removeArtifacts: true
          artifacts: "${{ env.PLUGIN_NAME }}.jar,${{ env.VERSIONED_BASENAME }}"
